### **AI单据扫描机器人：苹果快捷指令自动化操作手册**

**版本 1.0**

#### **手册简介**

本手册将指导您创建一个强大且高度自动化的快捷指令工作流。该“机器人”可以实现以下功能：

  * **一键扫描**：通过相机快速捕捉任何单据、收据或发票。
  * **智能识别**：利用先进的AI（Google Gemini）“读懂”并提取单据中的关键信息（如商家、金额、日期）。
  * **自动入库**：将结构化的数据自动填入您指定的Apple Numbers电子表格中。
  * **无痕操作**：扫描过程中的照片不会保存在您的相册中，保持相册整洁。

本流程适用于任何需要频繁记录票据信息，并希望从手动录入中解放出来的用户。

-----

### **第一部分：准备工作 (Prerequisites)**

在开始创建快捷指令之前，您需要完成两项准备工作。

#### **1. 获取Google Gemini API密钥**

我们的快捷指令需要一个“大脑”来理解单据内容，我们将使用Google的Gemini Pro模型。您需要一个API密钥来授权您的快捷指令调用它。

1.  **访问Google AI Studio**：在浏览器中打开 [https://aistudio.google.com/](https://aistudio.google.com/)。
2.  **登录账户**：使用您的Google账户登录。
3.  **获取API密钥**：点击页面左侧的 "**Get API key**"（获取API密钥）按钮。
4.  **创建密钥**：点击 "**Create API key in new project**"（在新项目中创建API密钥）。
5.  **复制并保存**：系统会生成一长串字符，这就是您的API密钥。**立即复制**并将其保存在一个安全的地方（如备忘录或密码管理器中），我们稍后会用到它。**请勿泄露此密钥**。

#### **2. 创建Numbers电子表格**

您需要一个地方来存放提取出的数据。

1.  打开 **Numbers (表格)** 应用。
2.  创建一个新的**空白表格**。
3.  **重命名文件**，例如命名为“**我的账本**”。
4.  **设置表头**：在第一行，根据您的需求设置列名。为方便本手册操作，请依次设置以下四个表头：
      * A列: `日期`
      * B列: `商家`
      * C列: `金额`
      * D列: `备注` (可选)

准备工作完成！现在我们可以开始构建快捷指令了。

-----

### **第二部分：创建快捷指令 (Step-by-Step Guide)**

请严格按照以下步骤操作，我们将一步步构建这个强大的自动化工具。

1.  **新建快捷指令**

      * 打开“快捷指令”App，点击右上角的 `+` 号，创建一个新的快捷指令。
      * 点击顶部，将其重命名为“**AI记账机器人**”。

2.  **步骤一：拍照 (Take Photo)**

      * 点击“添加操作”，搜索并选择 **`拍照`**。
      * 点击该操作右侧的蓝色 `>` 箭头，展开选项。
      * **关键操作**：**关闭** `存储到相册` 的开关。

3.  **步骤二：提取文本 (Extract Text from Image)**

      * 在下方搜索框中，搜索并添加 **`从图像中提取文本`**。
      * 它会自动将上一步的 `照片` 作为输入。

4.  **步骤三：储存API密钥 (Store API Key)**

      * 添加 **`文本`** 操作。
      * 将您在第一部分获取的 **Gemini API密钥** 粘贴到这个文本框中。这比将密钥直接写入URL更安全、更易于管理。

5.  **步骤四：构建AI提示词 (Construct AI Prompt)**

      * 再次添加一个 **`文本`** 操作。
      * 将以下**全部内容**准确地复制并粘贴到文本框中。这是您给AI下达的指令，至关重要。

    > You are an expert data extractor for receipts. From the text below, identify the merchant name, the total amount, and the transaction date. If you cannot find a value for a field, use "N/A". Provide the output ONLY in a valid JSON format with the keys "date", "merchant", and "total".

    > Raw Text:
    > `[从“图像”中提取的文本]`

      * **操作指引**: 输入完毕后，将光标放在 `[从“图像”中提取的文本]` 这几个字上（或者直接删除它），然后从下方的变量栏中选择蓝色的 `从“图像”中提取的文本` 变量，将其插入到正确位置。

6.  **步骤五：构建API请求体 (Build API Request Body)**

      * 添加 **`词典`** 操作。这是构建发送给API的JSON数据的标准方式。
      * 添加一个新项目，设置键（Key）为 `contents`，类型为 `数组 (Array)`。
      * 在 `contents` 数组下，添加一个新项目，类型为 `词典 (Dictionary)`。
      * 在这个新的词典下，添加一个新项目，键为 `parts`，类型为 `数组 (Array)`。
      * 在 `parts` 数组下，添加一个新项目，类型为 `词典 (Dictionary)`。
      * 在最后一个词典下，添加一个新项目，键为 `text`，类型为 `文本 (Text)`。
      * 点击 `text` 旁边的值字段，从变量中选择您在 **步骤四** 创建的 `文本` (即AI提示词)。

7.  **步骤六：调用AI接口 (Get Contents of URL)**

      * 添加 **`获取URL内容`** 操作。
      * 在URL栏中，粘贴以下地址。并将末尾的 `YOUR_API_KEY` 替换为您在 **步骤三** 中储存的API密钥变量。
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=[API密钥变量]`
      * 展开高级选项：
          * **方法**: 选择 `POST`。
          * **头**: 添加一个新的头，键为 `Content-Type`，值为 `application/json`。
          * **请求体**: 选择 `文件`，然后在值的位置选择您在 **步骤五** 创建的 `词典` 变量。

8.  **步骤七：解析AI返回结果 (Parse AI Response)**

      * AI返回的数据是嵌套的，我们需要一步步把它拆解出来。
      * 添加 **`获取词典的值`**，从 `URL内容` 中获取键 `candidates` 的值。
      * 添加 **`从列表中获取项目`**，从上一步的 `词典值` 中获取 `第一个项目`。
      * 添加 **`获取词典的值`**，从上一步的 `列表中的项目` 中获取键 `content` 的值。
      * 添加 **`获取词典的值`**，从上一步的 `词典值` 中获取键 `parts` 的值。
      * 添加 **`从列表中获取项目`**，从上一步的 `词典值` 中获取 `第一个项目`。
      * 添加 **`获取词典的值`**，从上一步的 `列表中的项目` 中获取键 `text` 的值。经过这系列操作，我们就得到了AI返回的干净的JSON文本。

9.  **步骤八：解析业务数据 (Parse Business Data)**

      * 添加 **`从输入中获取词典`**，将上一步最终获取的 `词典值` 作为输入。现在，快捷指令就能理解JSON的结构了。
      * 添加 **`获取词典的值`**，从上一步的 `词典` 中获取键 `date` 的值。长按这个 `词典值` 变量，将其重命名为 `日期`。
      * 重复两次，分别获取键 `merchant` (重命名为 `商家`) 和 `total` (重命名为 `金额`) 的值。

10. **步骤九：写入表格 (Add Row to Spreadsheet)**

      * 添加 **`将行添加到电子表格`** 操作。
      * **电子表格**: 选择您在准备工作中创建的“**我的账本**”。
      * **工作表**: 选择默认的那个即可。
      * 您会看到表格中的列名已经显示出来。在 `日期` 字段，填入 `日期` 变量；在 `商家` 字段，填入 `商家` 变量；在 `金额` 字段，填入 `金额` 变量。
      * (可选) 您可以添加一个 `显示提醒` 操作，内容为“记账成功！”，给自己一个正反馈。

**恭喜！您的AI记账机器人已经构建完成！** 点击右下角的运行按钮进行测试。

-----

### **第三部分：使用与自定义**

#### **如何使用**

1.  **添加到主屏幕**：在快捷指令的编辑界面，点击顶部的名称，选择“添加到主屏幕”，方便您一键启动。
2.  **运行流程**：点击图标 -\> 自动打开相机 -\> 对准单据拍照 -\> 完成。数据会自动出现在您的Numbers表格中。

#### **自定义与扩展**

  * **添加确认步骤**：在写入表格之前，可以添加 `显示结果` 或 `显示提醒`，让您确认AI提取的信息是否准确。
  * **提取更多字段**：想提取“商品列表”或“税额”？只需两步：
    1.  修改 **步骤四** 的AI提示词，告诉AI您需要新的字段和JSON键。
    2.  修改 **步骤九**，添加相应的 `获取词典的值` 操作。
  * **保存到不同应用**：不使用Numbers？可以将最后一步替换为 **`追加到备忘录`** 或 **`创建提醒事项`**。

-----

### **第四部分：常见问题 (FAQ)**

  * **快捷指令运行失败怎么办？**

      * **检查API密钥**：确认 **步骤三** 中的密钥是否完整且正确。
      * **检查网络连接**：调用AI需要联网。
      * **检查API请求体**：仔细核对 **步骤五** 和 **步骤六** 的词典结构和URL设置，这是最容易出错的地方。

  * **AI提取的信息不准确？**

      * 这是“提示词工程”的范畴。回到 **步骤四**，尝试用更清晰、更具体的语言向AI描述您的需求。例如，明确日期格式、金额是否需要包含货币符号等。

  * **解析JSON时出错？**

      * 有时AI可能因为某些原因没有返回严格的JSON。您可以在调用API后，先加一个 `显示结果`，看看AI到底返回了什么原始数据，再进行排查。
